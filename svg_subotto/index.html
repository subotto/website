<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Test Subbotto SVG</title>

  <!--<link rel="stylesheet" href="css/styles.css?v=1.0">-->

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  
   <script src="js/jquery.js"></script>
  <script src="js/svg.js"></script>

</head>

<body>
	
	<script>
		var field_width=380;
		var field_height=640;
		
		function cart2pol(p) {
			return [p[0],Math.sqrt(p[1]*p[1]+p[2]*p[2]), Math.atan2(p[2],p[1])];
		}
		
		function pol2cart(p) {
			return [p[0],p[1]*Math.cos(p[2]), p[1]*Math.sin(p[2])];
		}		
		
		function subx2x(sx) {
			return (sx+1)*field_width/2;
		}
		
		function suby2y(sy) {
			return (sy+1)*field_height/2;
		}
				
		function create_player(draw, color) {
			var player=new Object();
			
			var mesh_points_cart=[
				[0,-72,-13],
				[13,-64,-13],
				[16,-51,-10],
				[16,-51,8],
				[10,-35,7],
				
				[10,-35,-12],
				[30,-24,-12],
				[30,24,-12],
				[30,24,	12],
				[26,31,12],
				[15,100,12],
				[15,100,-9],
				[20,102,-11],
				[20,102,16],
				[21,134,16],
				//simmetrico
				[-21,134,16],
				[-20,102,16],
				[-20,102,-11],
				[-15,100,-9],
				[-15,100,12],
				[-26,31,12],
				[-30,24,12],
				[-30,24,-12],
				[-30,-24,-12],
				[-10,-35,-12],
				
				[-10,-35,7],
				[-16,-51,8],
				[-16,-51,-10],
				[-13,-64,-13],
			];
			
			player.mesh_points=mesh_points_cart.map(cart2pol);
			player.rotated_mesh=player.mesh_points.slice();

			player.x=0;
			player.y=0;
						
			player.move = function(x,y){
				player.x=x;
				player.y=y;
			}
			
			player.angle=0.0;
			
			player.rotate = function(angle) {	

				player.angle=angle;
				if (-Math.PI/2 <= angle && angle <= 0) {
					player.rotated_mesh=player.mesh_points.map(function(d) {return [d[0],d[1],d[2]+player.angle];});
				}
				if (-Math.PI <= angle && angle < -Math.PI/2) {
					player.rotated_mesh=player.mesh_points.map(function(d) {return [d[0],d[1],d[2]-(player.angle+Math.PI)];});
					player.rotated_mesh=player.rotated_mesh.map(function(d) {return [d[0],-d[1],d[2]];});
				}
				if (0 < angle && angle <= Math.PI) {
					player.rotate(-angle);
				}
			}
			
			player.group=draw.group();
			player.path=player.group.path('',true);
			player.fill=player.group.path('',true);
			
			player.path.attr({ fill: 'none' , stroke: '#000', 'stroke-width': 2})
			player.fill.attr({stroke: 'none'}); //'fill-opacity': 0.85,
			if (color==0) {
				player.fill.attr('fill','#f00');
			}
			else {
				player.fill.attr('fill','#00f');
			}
			
			player.scale=0.25;
			
			player.draw = function() {
				var points=player.rotated_mesh.map(pol2cart);
				points=points.map(function(p) {
					return [p[0]*player.scale +subx2x(player.x),p[1]*player.scale+suby2y(player.y),p[2]*player.scale];}
				);
				var s="M ";
				for (var i=0;i<points.length;++i) {
					s+=points[i][0]+","+points[i][1]+" ";
				}
				s+="z"
				
				player.path.attr('d',s);
				player.fill.attr('d',s);
				
			}
			
			return player;
		}
		
		function create_rod(draw,player_number, offset, color) {
			var rod=[];
			
			for (var i=0; i<player_number;i++) {
				rod[i]=create_player(draw, color);
				rod[i].move((-(player_number-1)/2.0+i)*offset, 0);
			}
			
			rod.rotate=function(angle) {
				if (angle==null) return;
				for (var i=0; i<player_number;i++) {
					rod[i].rotate(angle);
				}				
			}
			
			rod.x=0;
			rod.y=0;
			
			rod.move=function(x,y) {
				dx=x-rod.x;
				dy=y-rod.y;
				
				rod.x=x;
				rod.y=y;
				
				for (var i=0; i<player_number;i++) {
					rod[i].move(rod[i].x+dx, rod[i].y+dy);
				}	
			}
			
			rod.offset=function(offset) {
				if (offset==null) return;
				rod.move(offset,rod.y);
			}
			
			rod.draw=function() {
				for (var i=0; i<player_number;i++) {
					rod[i].draw();
				}
			}
			
			return rod;
		}
		
		function create_ball(draw) {
			var ball=new Object();
			
			ball.x=0;
			ball.y=0;
			
			ball.move = function(x,y) {
				if (x==null || y==null)
					return;
				ball.x=x;
				ball.y=y;

			}
			
			ball.path=draw.circle(20);
			ball.path.attr({ fill: '#fff' , stroke: '#000', 'stroke-width': 2})
			
			ball.draw=function() {
				ball.path.move(subx2x(ball.x)-ball.path.bbox().width/2, suby2y(ball.y)-ball.path.bbox().height/2);
			}
      ball.draw();
			
			return ball;
		}
		
		function create_table(draw) {
			var table=new Object();
			
			table.ball = create_ball(draw);
			
			rods_red=[];
			rods_red[0]=create_rod(draw,1,0,0);
			rods_red[0].move(0,-0.9328);
			rods_red[1]=create_rod(draw,2,0.63,0);
			rods_red[1].move(0,-0.66613);
			rods_red[2]=create_rod(draw,5,0.31,0);
			rods_red[2].move(0,-0.13323);
			rods_red[3]=create_rod(draw,3,0.558,0);
			rods_red[3].move(0,0.39968);
			
			rods_red.draw=function() {
				for (var i=0; i<rods_red.length;i++) {
					rods_red[i].draw();
				}
			}
			
			rods_blue=[];
			rods_blue[0]=create_rod(draw,1,0,1);
			rods_blue[0].move(0,+0.9328);
			rods_blue[1]=create_rod(draw,2,0.63,1);
			rods_blue[1].move(0,+0.66613);
			rods_blue[2]=create_rod(draw,5,0.31,1);
			rods_blue[2].move(0,+0.13323);
			rods_blue[3]=create_rod(draw,3,0.558,1);
			rods_blue[3].move(0,-0.39968);
			
			rods_blue.draw=function() {
				for (var i=0; i<rods_red.length;i++) {
					rods_blue[i].draw();
				}
			}
			
			table.rods_red=rods_red;
			table.rods_blue=rods_blue;
			
			
			table.draw=function() {
				table.rods_red.draw();
				table.rods_blue.draw();
				table.ball.draw();
			}
			
			table.rotate=function(c,i,angle) {
				if (c==0)
					table.rods_red[i].rotate(angle);
				if (c==1)
					table.rods_blue[i].rotate(angle);
			}
			
			return table;
		}
	</script>
	
	<input type="range" id="angle_slider" min="-314" max="314"><span id="angle_value"></span>
	<!--<div id="canvas" style="width:380px; height: 640px; background: green;"></div>-->
	
	<div id="debug_div"></div>
  <div id="frames_div"></div>
	
	<div>
		<svg id="dfse" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="640.18" width="380.17" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/">
			  <defs id="defs4066">
			  <linearGradient id="linearGradient4088" y2="-320.09" gradientUnits="userSpaceOnUse" x2="654.29" y1="-320.09" x1="643.83">
			   <stop id="stop3856" stop-color="#b3b3b3" offset="0"/>
			   <stop id="stop3862" stop-color="#FFF" offset="0.68649"/>
			   <stop id="stop3858" stop-color="#b3b3b3" offset="1"/>
			  </linearGradient>
			 </defs>
			 <metadata id="metadata4069">
			  <rdf:RDF>
			   <cc:Work rdf:about="">
				<dc:format>image/svg+xml</dc:format>
				<dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
				<dc:title/>
			   </cc:Work>
			  </rdf:RDF>
			 </metadata>
			 <g id="layer1" transform="translate(-130.00189,-542.18658)">
			  <rect id="rect3050" stroke-dashoffset="0" transform="matrix(0,1,-1,0,0,0)" height="379.17" width="639.18" stroke="#000" stroke-dasharray="none" stroke-miterlimit="4" y="-509.68" x="542.69" stroke-width="1" fill="#008000"/>
			  <g id="g3962" transform="matrix(0,1.0917603,-1.0917603,0,921.21908,474.33004)" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="0.91024995">
			   <path id="path3940" d="m418.57,556.29c0,28.995-23.505,52.5-52.5,52.5s-52.5-23.505-52.5-52.5,23.505-52.5,52.5-52.5,52.5,23.505,52.5,52.5z" transform="matrix(0.95956873,0,0,0.95956873,4.0685632,16.807262)" fill="#FFF"/>
			   <path id="path3942" d="m418.57,556.29c0,28.995-23.505,52.5-52.5,52.5s-52.5-23.505-52.5-52.5,23.505-52.5,52.5-52.5,52.5,23.505,52.5,52.5z" transform="matrix(0.81132075,0,0,0.81132075,58.337914,99.276244)" fill="#008000"/>
			  </g>
			  <rect id="rect3944" transform="matrix(0,1,-1,0,0,0)" height="357.67" width="10.12" y="-493.33" x="857.22" fill="#FFF"/>
			  <g id="g4766" transform="matrix(0,-1,-1,0,855.54649,1271.7825)">
			   <g id="g4768" transform="matrix(1.0025241,0,0,1.2504514,-0.61957009,-137.47639)">
				<path id="path4770" d="m230.31,555.37c0,30.126-24.422,54.548-54.548,54.548s-54.548-24.422-54.548-54.548,24.422-54.548,54.548-54.548,54.548,24.422,54.548,54.548z" transform="matrix(1.4628994,0,0,1.1728499,-87.518857,-113.20933)" fill="#FFF"/>
				<path id="path4772" d="m230.31,555.37c0,30.126-24.422,54.548-54.548,54.548s-54.548-24.422-54.548-54.548,24.422-54.548,54.548-54.548,54.548,24.422,54.548,54.548z" transform="matrix(1.2877751,0,0,1.0324476,-56.737853,-35.234441)" fill="#008000"/>
			   </g>
			   <rect id="rect4774" height="229.05" width="133.87" y="423.38" x="89.418" fill="#FFF"/>
			   <rect id="rect4776" height="213.66" width="125.19" y="431.07" x="89.418" fill="#008000"/>
			   <rect id="rect4778" height="155.43" width="57.462" y="459.57" x="89.418" fill="#FFF"/>
			   <rect id="rect4780" height="137.79" width="47.736" y="468.39" x="89.418" fill="#008000"/>
			  </g>
			  <rect id="rect3832" stroke-dashoffset="0" transform="matrix(0,1,-1,0,0,0)" height="26.7" width="535.47" stroke="#000" stroke-dasharray="none" stroke-miterlimit="4" y="-157.34" x="589.3" stroke-width="0.5" fill="#FFF"/>
			  <rect id="rect3830" stroke-dashoffset="0" transform="matrix(0,1,-1,0,0,0)" height="26.7" width="535.47" stroke="#000" stroke-dasharray="none" stroke-miterlimit="4" y="-509.54" x="589.3" stroke-width="0.5" fill="#FFF"/>
			  <g id="g4757" transform="matrix(0,1,-1,0,855.54649,453.10428)">
			   <g id="g4715" transform="matrix(1.0025241,0,0,1.2504514,-0.61957009,-137.47639)">
				<path id="path3914" d="m230.31,555.37c0,30.126-24.422,54.548-54.548,54.548s-54.548-24.422-54.548-54.548,24.422-54.548,54.548-54.548,54.548,24.422,54.548,54.548z" transform="matrix(1.4628994,0,0,1.1728499,-87.518857,-113.20933)" fill="#FFF"/>
				<path id="path3916" d="m230.31,555.37c0,30.126-24.422,54.548-54.548,54.548s-54.548-24.422-54.548-54.548,24.422-54.548,54.548-54.548,54.548,24.422,54.548,54.548z" transform="matrix(1.2877751,0,0,1.0324476,-56.737853,-35.234441)" fill="#008000"/>
			   </g>
			   <rect id="rect3904" height="229.05" width="133.87" y="423.38" x="89.418" fill="#FFF"/>
			   <rect id="rect3906" height="213.66" width="125.19" y="431.07" x="89.418" fill="#008000"/>
			   <rect id="rect3908" height="155.43" width="57.462" y="459.57" x="89.418" fill="#FFF"/>
			   <rect id="rect3910" height="137.79" width="47.736" y="468.39" x="89.418" fill="#008000"/>
			  </g>
			  <path id="path3820" stroke-linejoin="miter" d="m378.37,542.8,104.33,104.11,26.829-16.112,0-87.997z" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="0.5" fill="#FFF"/>
			  <path id="path3824" stroke-linejoin="miter" d="m261.81,542.8-104.34,104.11-26.829-16.112,0-87.997z" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="0.5" fill="#FFF"/>
			  <path id="path3826" stroke-linejoin="miter" d="m378.37,1181.7,104.33-104.11,26.829,16.112,0,87.998z" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="0.5" fill="#FFF"/>
			  <path id="path3828" stroke-linejoin="miter" d="m261.81,1181.7-104.34-104.11-26.829,16.112,0,87.998z" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="0.5" fill="#FFF"/>
			  <path id="path3960" d="m363.57,554.15c0,3.7476-2.8782,6.7857-6.4286,6.7857s-6.4286-3.0381-6.4286-6.7857,2.8782-6.7857,6.4286-6.7857,6.4286,3.0381,6.4286,6.7857z" transform="matrix(0,1.1666667,-1.1052632,0,932.56804,445.60867)" fill="#FFF"/>
			  <rect id="rect3836" stroke-dasharray="none" transform="matrix(0,1,-1,0,0,0)" height="379.14" width="9.8592" stroke="#000" stroke-miterlimit="4" y="-509.66" x="644.13" stroke-width="0.5" fill="url(#linearGradient4088)"/>
			  <use id="use4895" xlink:href="#rect3836" transform="translate(0,85.285711)" height="1052.3622" width="744.09448" y="0" x="0"/>
			  <use id="use4897" xlink:href="#rect3836" transform="translate(0,170.57147)" height="1052.3622" width="744.09448" y="0" x="0"/>
			  <use id="use4899" xlink:href="#rect3836" transform="translate(0,255.85718)" height="1052.3622" width="744.09448" y="0" x="0"/>
			  <use id="use4901" xlink:href="#rect3836" transform="translate(0,341.14292)" height="1052.3622" width="744.09448" y="0" x="0"/>
			  <use id="use4907" xlink:href="#rect3836" transform="translate(0,426.42865)" height="1052.3622" width="744.09448" y="0" x="0"/>
			  <use id="use3241" xlink:href="#rect3836" transform="translate(0,-85.285777)" height="640.17749" width="380.17374" y="0" x="0"/>
			  <use id="use3243" xlink:href="#rect3836" transform="translate(0,511.71437)" height="640.17749" width="380.17374" y="0" x="0"/>
			 </g>
			 <svg id="canvas">
			 </svg>
			</svg>
	</div>
	<div id="time"></div>
	<script>
		var draw = SVG('canvas');
    var fps = 10.0;
		
		var table=create_table(draw);
		table.rotate(0,0,-Math.PI/2);
		table.rotate(0,1,-Math.PI/2);
		table.rotate(0,2,-Math.PI/2);
		
		table.draw();
		
		$("#angle_slider").change(function() {
			table.rotate(0,0,$('#angle_slider').val()/100);
			table.rotate(0,1,$('#angle_slider').val()/100);
			table.rotate(0,2,$('#angle_slider').val()/100);
			table.rotate(0,3,$('#angle_slider').val()/100);
			$('#angle_value').text($('#angle_slider').val());
			table.draw();
		});
		
		function display_frame(frame) {
			table.ball.move(frame.ball_y, frame.ball_x); // Sto disegnando in verticale quindi sono invertiti
			
			table.rods_red[0].offset(frame.rod_red_0_shift);
			table.rods_red[1].offset(frame.rod_red_1_shift);
			table.rods_red[2].offset(frame.rod_red_2_shift);
			table.rods_red[3].offset(frame.rod_red_3_shift);
			
			table.rods_red[0].rotate(frame.rod_red_0_angle);
			table.rods_red[1].rotate(frame.rod_red_1_angle);
			table.rods_red[2].rotate(frame.rod_red_2_angle);
			table.rods_red[3].rotate(frame.rod_red_3_angle);
			
			table.rods_blue[0].offset(frame.rod_blue_0_shift);
			table.rods_blue[1].offset(frame.rod_blue_1_shift);
			table.rods_blue[2].offset(frame.rod_blue_2_shift);
			table.rods_blue[3].offset(frame.rod_blue_3_shift);
			
			table.rods_blue[0].rotate(frame.rod_blue_0_angle);
			table.rods_blue[1].rotate(frame.rod_blue_1_angle);
			table.rods_blue[2].rotate(frame.rod_blue_2_angle);
			table.rods_blue[3].rotate(frame.rod_blue_3_angle);
			
			table.draw();
			
		}
		
		function debug(s) {
			//$("#debug_div").html($("#debug_div").html()+"<br>"+s)
      //$("#debug_div").html(s)
		}

function repr_frames() {
    var res = "";
    for (var i = 0; i < frames.length; i++) {
        res = res + " " + frames[i].timestamp;
    }
return res;
}

    function print_frames() {
        //$("#frames_div").html(repr_frames());
    }
		
		var time_delta=-1;
		var frames=[];
		function addNewFrames(response) {
        if (fps != response.fps) {
            fps = response.fps;
            update_everything_timer();
        }
        if (response.data.length > 0)
            debug("Adding frames!");
        else
            debug("No new frames to add.");
        updating_frames = false;
			  frames=frames.concat(response.data);
        if (frames.length > 0) {
            last_timestamp=frames[frames.length-1].timestamp;
        }
			if (time_delta<0) {
				time_delta=(new Date().getTime())/1000 - frames[0].timestamp;
				//debug(time_delta);
			}
		}
		
		/*$.getJSON("http://127.0.0.1:8000/", null,
				addNewFrames
				);
			*/	
		
stop = false;

function update_everything() {
        if (stop) return;
      var current_time = (new Date().getTime())/1000;
			var actual_time=current_time - time_delta;
			
			debug("current_time=" + current_time + " actual_time = " + actual_time);
			  debug(repr_frames());
			// Rimuove i frame vecchi
			for (var i=0;i<frames.length;++i) {
				if (frames[i].timestamp >= actual_time)
					break;
			}
			frames=frames.slice(i);
        debug(repr_frames());
			
			//debug("removed " + i + " frames");
			
			  if (frames.length==0) {
            time_delta += 1/fps;
            return;
        }
			
		var frame=frames[0];
		debug("displaying t="+frame.timestamp+" length="+frames.length+" actual_time="+actual_time);

	$("#time").html("Time: "+time_delta)	

      display_frame(frame);
      print_frames();
}

update_everything_handle = null;

function update_everything_timer() {
    if (update_everything_handle != null) {
        clearInterval(update_everything_handle);
    }
    update_everything_handle = setInterval(update_everything, 1000/fps);
}
update_everything_timer();

last_timestamp = null;
updating_frames = false;
		setInterval(function(){
        if (stop) return;
        if (updating_frames) return;
        updating_frames = true;
			if (last_timestamp != null) {
				  $.getJSON("/subtracker/subtracker.json", {'last_timestamp' : last_timestamp.toFixed(6)},
					          addNewFrames);
			} else {
				  $.getJSON("/subtracker/subtracker.json", {'last_timestamp' : "0"},
					          addNewFrames);
			}
		}, 1000/2);
		/*
		setInterval(function(){
			var d = new Date();
			var n = d.getMilliseconds();
			
			var angle=(n-500)/500.0*Math.PI;
			table.rotate(0,0,angle);
			table.rotate(0,1,angle);
			table.rotate(0,2,angle);
			table.rotate(0,3,angle);
			
			table.rotate(1,0,angle);
			table.rotate(1,1,angle);
			table.rotate(1,2,angle);
			table.rotate(1,3,angle);
			
			table.rods_red[0].move(Math.abs(angle)/10,-0.9258);
			
			table.draw();
		},1000/24);
		*/
	</script>
</body>

</html>
