<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Test Subbotto SVG</title>

  <!--<link rel="stylesheet" href="css/styles.css?v=1.0">-->

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  
   <script src="js/jquery.js"></script>
  <script src="js/svg.js"></script>

</head>

<body>
	
	<script>
		function cart2pol(p) {
			return [p[0],Math.sqrt(p[1]*p[1]+p[2]*p[2]), Math.atan2(p[2],p[1])];
		}
		
		function pol2cart(p) {
			return [p[0],p[1]*Math.cos(p[2]), p[1]*Math.sin(p[2])];
		}		
		
		function subx2x(draw,sx) {
			return (sx+1)*draw.viewbox().width/2;
		}
		
		function suby2y(draw,sy) {
			return (sy+1)*draw.viewbox().height/2;
		}
				
		function create_player(draw, color) {
			var player=new Object();
			
			var mesh_points_cart=[
				[0,-72,-13],
				[13,-64,-13],
				[16,-51,-10],
				[16,-51,8],
				[10,-35,7],
				
				[10,-35,-12],
				[30,-24,-12],
				[30,24,-12],
				[30,24,	12],
				[26,31,12],
				[15,100,12],
				[15,100,-9],
				[20,102,-11],
				[20,102,16],
				[21,134,16],
				//simmetrico
				[-21,134,16],
				[-20,102,16],
				[-20,102,-11],
				[-15,100,-9],
				[-15,100,12],
				[-26,31,12],
				[-30,24,12],
				[-30,24,-12],
				[-30,-24,-12],
				[-10,-35,-12],
				
				[-10,-35,7],
				[-16,-51,8],
				[-16,-51,-10],
				[-13,-64,-13],
			];
			
			player.mesh_points=mesh_points_cart.map(cart2pol);
			player.rotated_mesh=player.mesh_points.slice();

			player.x=0;
			player.y=0;
						
			player.move = function(x,y){
				player.x=x;
				player.y=y;
			}
			
			player.angle=0.0;
			
			player.rotate = function(angle) {	

				player.angle=angle;
				if (-Math.PI/2 <= angle && angle <= 0) {
					player.rotated_mesh=player.mesh_points.map(function(d) {return [d[0],d[1],d[2]+player.angle];});
				}
				if (-Math.PI <= angle && angle < -Math.PI/2) {
					player.rotated_mesh=player.mesh_points.map(function(d) {return [d[0],d[1],d[2]-(player.angle+Math.PI)];});
					player.rotated_mesh=player.rotated_mesh.map(function(d) {return [d[0],-d[1],d[2]];});
				}
				if (0 < angle && angle <= Math.PI) {
					player.rotate(-angle);
				}
			}
			
			player.group=draw.group();
			player.path=player.group.path('',true);
			player.fill=player.group.path('',true);
			
			player.path.attr({ fill: 'none' , stroke: '#000', 'stroke-width': 2})
			player.fill.attr({stroke: 'none'}); //'fill-opacity': 0.85,
			if (color==0) {
				player.fill.attr('fill','#f00');
			}
			else {
				player.fill.attr('fill','#00f');
			}
			
			player.scale=0.25;
			
			player.draw = function() {
				var points=player.rotated_mesh.map(pol2cart);
				points=points.map(function(p) {
					return [p[0]*player.scale +subx2x(draw,player.x),p[1]*player.scale+suby2y(draw,player.y),p[2]*player.scale];}
				);
				var s="M ";
				for (var i=0;i<points.length;++i) {
					s+=points[i][0]+","+points[i][1]+" ";
				}
				s+="z"
				
				player.path.attr('d',s);
				player.fill.attr('d',s);
				
			}
			
			return player;
		}
		
		function create_rod(draw,player_number, offset, color) {
			var rod=[];
			
			for (var i=0; i<player_number;i++) {
				rod[i]=create_player(draw, color);
				rod[i].move((-(player_number-1)/2.0+i)*offset, 0);
			}
			
			rod.rotate=function(angle) {
				for (var i=0; i<player_number;i++) {
					rod[i].rotate(angle);
				}				
			}
			
			rod.x=0;
			rod.y=0;
			
			rod.move=function(x,y) {
				dx=x-rod.x;
				dy=y-rod.y;
				
				rod.x=x;
				rod.y=y;
				
				for (var i=0; i<player_number;i++) {
					rod[i].move(rod[i].x+dx, rod[i].y+dy);
				}	
			}
			
			rod.draw=function() {
				for (var i=0; i<player_number;i++) {
					rod[i].draw();
				}
			}
			
			return rod;
		}
		
		function create_table(draw) {
			var table=new Object();
			
			rods_red=[];
			rods_red[0]=create_rod(draw,1,0,0);
			rods_red[0].move(0,-0.875);
			rods_red[1]=create_rod(draw,2,0.63,0);
			rods_red[1].move(0,-0.625);
			rods_red[2]=create_rod(draw,5,0.31,0);
			rods_red[2].move(0,-0.125);
			rods_red[3]=create_rod(draw,3,0.558,0);
			rods_red[3].move(0,0.375);
			
			rods_red.draw=function() {
				for (var i=0; i<rods_red.length;i++) {
					rods_red[i].draw();
				}
			}
			
			rods_blue=[];
			rods_blue[0]=create_rod(draw,1,0,1);
			rods_blue[0].move(0,+0.875);
			rods_blue[1]=create_rod(draw,2,0.63,1);
			rods_blue[1].move(0,+0.625);
			rods_blue[2]=create_rod(draw,5,0.31,1);
			rods_blue[2].move(0,+0.125);
			rods_blue[3]=create_rod(draw,3,0.558,1);
			rods_blue[3].move(0,-0.375);
			
			rods_blue.draw=function() {
				for (var i=0; i<rods_red.length;i++) {
					rods_blue[i].draw();
				}
			}
			
			table.rods_red=rods_red;
			table.rods_blue=rods_blue;
			table.draw=function() {
				table.rods_red.draw();
				table.rods_blue.draw();
			}
			
			table.rotate=function(c,i,angle) {
				if (c==0)
					table.rods_red[i].rotate(angle);
				if (c==1)
					table.rods_blue[i].rotate(angle);
			}
			
			return table;
		}
	</script>
	
	<input type="range" id="angle_slider" min="-314" max="314"><span id="angle_value"></span>
	<div id="canvas" style="width:380px; height: 640px; background: green;"></div>
	
	<script>
		var draw = SVG('canvas');
		
		var table=create_table(draw);
		table.rotate(0,0,-Math.PI/2);
		table.rotate(0,1,-Math.PI/2);
		table.rotate(0,2,-Math.PI/2);
		
		table.draw();
		
		$("#angle_slider").change(function() {
			table.rotate(0,0,$('#angle_slider').val()/100);
			table.rotate(0,1,$('#angle_slider').val()/100);
			table.rotate(0,2,$('#angle_slider').val()/100);
			table.rotate(0,3,$('#angle_slider').val()/100);
			$('#angle_value').text($('#angle_slider').val());
			table.draw();
		});
		
		setInterval(function(){
			angle=(Date.now()%2000-1000)/1000.0*Math.PI;
			table.rotate(0,0,angle);
			table.rotate(0,1,angle);
			table.rotate(0,2,angle);
			table.rotate(0,3,angle);
			
			table.rotate(1,0,angle);
			table.rotate(1,1,angle);
			table.rotate(1,2,angle);
			table.rotate(1,3,angle);
			
			table.rods_red[0].move(Math.abs(angle)/10,-0.875);
			
			table.draw();
		},1000/24);
	</script>
</body>

</html>
